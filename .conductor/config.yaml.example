# Conductor Configuration File
#
# Place this file at .conductor/config.yaml in your project root to set default values
# for Conductor CLI commands. CLI flags will override these settings.
#
# Example usage:
#   conductor run plan.md                    # Uses config.yaml defaults
#   conductor run --verbose plan.md          # Verbose flag overrides config
#   conductor run --timeout 2h plan.md       # Timeout flag overrides config

# Maximum number of concurrent tasks
# Set to 0 for unlimited concurrency (default: 0)
max_concurrency: 4

# Task execution timeout
# Supported formats: 30s, 5m, 1h30m, etc.
# Empty means no timeout (default: empty)
timeout: 5m

# Logging level
# Levels: trace, debug, info, warn, error (default: info)
log_level: info

# Log output directory
# Logs will be written to this directory (default: .conductor/logs)
log_dir: .conductor/logs

# Console output configuration
console:
  # Color output control
  # - auto: Auto-detect based on TTY (isatty check) - default
  # - true: Force colors on
  # - false: Force colors off
  # Note: The NO_COLOR environment variable is NOT checked.
  # Color control is exclusively via this config setting.
  colors_enabled: auto

# Dry run mode
# When true, validates and shows what would run without executing (default: false)
dry_run: false

# Skip completed tasks
# When true, skips tasks that are already marked as completed in the plan file (default: false)
skip_completed: false

# Retry failed tasks
# When true, retries tasks that previously failed (default: false)
retry_failed: false

# Quality control configuration
# Controls how tasks are reviewed and retried after execution
quality_control:
  # Enable or disable quality control reviews (default: true)
  enabled: true

  # DEPRECATED: Single agent for QC (use agents.explicit_list instead)
  # review_agent: conductor-qc

  # Multi-agent QC configuration (v2.2+)
  agents:
    # Selection mode: "auto", "explicit", "mixed", or "intelligent"
    # - auto: Auto-select based on file extensions (.go→golang-pro, .py→python-pro)
    # - explicit: Use only agents from explicit_list
    # - mixed: Auto-select + additional agents
    # - intelligent: Claude-based selection analyzing task context (v2.4+)
    mode: auto

    # Explicit list of agents (for mode=explicit)
    # explicit_list: [security-auditor, code-reviewer, golang-pro]

    # Additional agents to add to auto-selection (for mode=mixed)
    # additional: [security-auditor]

    # Agents to never use (for any mode)
    # blocked: [deprecated-agent]

    # Intelligent selection settings (v2.4+)
    # Maximum number of QC agents to select (default: 4)
    max_agents: 4

    # Cache TTL in seconds for intelligent selection results (default: 3600)
    cache_ttl_seconds: 3600

    # Always include code-reviewer as baseline (default: true)
    require_code_review: true

  # Number of retries on RED verdicts (default: from plan or 2)
  # Plans can override this with conductor.quality_control.retry_on_red
  # If not specified in plan, falls back to config value, then default 2
  retry_on_red: 2

# Feedback storage configuration
# Controls where and how task execution feedback is stored
feedback:
  # Store execution history in plan file (default: true)
  # Creates "Execution History" sections in Markdown or execution_history arrays in YAML
  store_in_plan_file: true

  # Store execution history in database (default: true)
  # Stores structured data in .conductor/learning/executions.db
  store_in_database: true

  # Format for agent/QC responses (default: json)
  # Options: json (structured), text (plain text)
  format: json

  # Control which verdicts trigger feedback storage
  # All enabled by default for complete execution history
  store_on_green: true
  store_on_red: true
  store_on_yellow: true

# ===== ADVANCED CONFIGURATION =====
# The settings below are optional and have sensible defaults.
# Uncomment and modify only if you need to change them.

# Example: Run with higher concurrency for parallel tasks
# max_concurrency: 8

# Example: Longer timeout for complex plans
# timeout: 10m

# Example: Debug mode for troubleshooting
# log_level: debug

# Example: Custom log directory
# log_dir: /var/log/conductor

# Example: Enable dry-run by default
# dry_run: true

# Example: Skip tasks that are already completed
# skip_completed: true

# Example: Retry tasks that failed in previous runs
# retry_failed: true

# Learning system configuration
# The learning system tracks task execution history and adapts future executions
learning:
  # Enable or disable the learning system (default: true)
  enabled: true

  # Database path for learning data (default: .conductor/learning/executions.db)
  # This should be a file path, not a directory
  db_path: .conductor/learning/executions.db

  # Auto-adapt agent selection based on learned patterns (default: false)
  # When enabled, conductor will automatically suggest or switch agents based on past successes
  auto_adapt_agent: false

  # Enable agent swapping during retry loops (default: true)
  # When a task fails repeatedly, swap to a better-performing agent suggested by QC or history
  swap_during_retries: true

  # Enhance prompts with learned context (default: true)
  # When enabled, conductor enriches task prompts with relevant execution history
  enhance_prompts: true

  # Enable QC to read plan file context (default: true)
  # QC agent loads execution history from current run's plan file before reviewing
  qc_reads_plan_context: true

  # Enable QC to read database context (default: true)
  # QC agent loads historical execution data from database before reviewing
  qc_reads_db_context: true

  # Maximum context entries to load (default: 10)
  # Limits the number of historical attempts included in QC context
  max_context_entries: 10

  # Minimum failures before adapting strategy (default: 2)
  # Conductor will consider adapting (swapping agents) after this many consecutive failures
  min_failures_before_adapt: 2

  # Days to keep execution history (default: 90)
  # Older execution records are cleaned up automatically
  keep_executions_days: 90

  # Maximum execution records per task (default: 100)
  # Limits the number of execution records kept for each unique task
  max_executions_per_task: 100

# Example: Disable learning system
# learning:
#   enabled: false

# Example: Custom learning database path (must be a file path, not directory)
# learning:
#   db_path: /var/lib/conductor/learning/executions.db

# Example: Enable automatic agent adaptation
# learning:
#   auto_adapt_agent: true
#   swap_during_retries: true
#   min_failures_before_adapt: 3

# Example: Disable QC context loading
# learning:
#   qc_reads_plan_context: false
#   qc_reads_db_context: false

# Example: Limit context to recent attempts only
# learning:
#   max_context_entries: 5

# Feedback Storage Examples

# Example: Store only failures
# feedback:
#   store_on_green: false
#   store_on_red: true
#   store_on_yellow: true

# Example: Store only in database, skip plan file updates
# feedback:
#   store_in_plan_file: false
#   store_in_database: true

# Example: Use plain text format instead of JSON
# feedback:
#   format: text

# Quality Control Examples

# Example: Enable stricter quality control with more retries
# quality_control:
#   enabled: true
#   retry_on_red: 3

# Example: Use explicit multi-agent QC (multiple reviewers)
# quality_control:
#   agents:
#     mode: explicit
#     explicit_list: [security-auditor, code-reviewer, golang-pro]
#   retry_on_red: 2

# Example: Use intelligent agent selection (Claude-based)
# quality_control:
#   agents:
#     mode: intelligent
#     max_agents: 3
#     cache_ttl_seconds: 1800
#     require_code_review: true
#     blocked: [deprecated-agent]
#   retry_on_red: 2

# Example: Use auto mode with additional security reviewer
# quality_control:
#   agents:
#     mode: mixed
#     additional: [security-auditor]
#   retry_on_red: 2

# Note: Plans can override the retry_on_red value in their frontmatter:
# conductor:
#   quality_control:
#     retry_on_red: 3  # This overrides config.yaml setting

# GUARD Protocol configuration (v2.17+)
# Pre-wave failure prediction using behavioral analytics
guard:
  # Enable or disable GUARD protocol (default: false)
  enabled: false

  # Operational mode:
  # - block: Hard gate - fails tasks with high failure probability
  # - warn: Soft signal - logs warning but allows execution (default)
  # - adaptive: Smart gate - blocks only when both probability AND confidence exceed thresholds
  mode: warn

  # Minimum failure probability to trigger action (0.0-1.0, default: 0.7)
  probability_threshold: 0.7

  # Minimum confidence for adaptive mode (0.0-1.0, default: 0.7)
  confidence_threshold: 0.7

  # Minimum historical sessions required for predictions (default: 5)
  # GUARD will skip prediction if fewer sessions are available
  min_history_sessions: 5

  # Predictive agent selection (v2.18+)
  # When enabled and GUARD predicts high failure probability, automatically
  # swaps to a better-performing agent based on historical performance data
  auto_select_agent: true

  # Enable verbose GUARD output (v2.22+)
  # When true, shows LLM analysis details and all recommendations
  # Useful for debugging and understanding GUARD decisions
  verbose: false

  # Real-time anomaly detection (v2.18+)
  # Monitors wave execution for anomalies and alerts in real-time
  anomaly_detection:
    # Enable or disable anomaly detection (default: true when GUARD is enabled)
    enabled: true

    # Alert after N consecutive task failures (default: 3)
    consecutive_failure_threshold: 3

    # Alert when wave error rate exceeds this percentage (0.0-1.0, default: 0.5)
    error_rate_threshold: 0.5

    # Alert when task duration exceeds N times the estimate (default: 2.0)
    duration_deviation_threshold: 2.0

  # LLM-Enhanced Prediction (v2.22+)
  # Uses gpt-oss via Ollama for intelligent failure prediction
  # Hybrid mode: stats-first, LLM only for uncertain predictions (0.3-0.7 probability)
  llm:
    # Enable LLM predictions (default: false, requires Ollama + gpt-oss)
    enabled: false

    # Ollama model (default: gpt-oss:latest)
    model: "gpt-oss:latest"

    # Reasoning depth: low, medium, high (default: medium)
    think_level: "medium"

    # Ollama API endpoint
    base_url: "http://localhost:11434"

    # Request timeout
    timeout: 60s

    # Fall back to stats if LLM fails
    fallback_to_stats: true

    # Only use LLM when stats are uncertain (between thresholds)
    min_probability_for_llm: 0.3
    max_probability_for_llm: 0.7

# GUARD Protocol Examples

# Example: Enable GUARD in warn mode (recommended starting point)
# guard:
#   enabled: true
#   mode: warn

# Example: Enable strict blocking mode
# guard:
#   enabled: true
#   mode: block
#   probability_threshold: 0.8

# Example: Enable adaptive mode (blocks only high-confidence predictions)
# guard:
#   enabled: true
#   mode: adaptive
#   probability_threshold: 0.7
#   confidence_threshold: 0.8

# Example: Disable GUARD at runtime with --no-guard flag
# conductor run --no-guard plan.yaml

# Example: Enable predictive agent selection (v2.18+)
# guard:
#   enabled: true
#   auto_select_agent: true

# Example: Configure anomaly detection thresholds (v2.18+)
# guard:
#   enabled: true
#   anomaly_detection:
#     enabled: true
#     consecutive_failure_threshold: 5
#     error_rate_threshold: 0.6
#     duration_deviation_threshold: 3.0

# Example: Disable anomaly detection while keeping GUARD enabled
# guard:
#   enabled: true
#   anomaly_detection:
#     enabled: false

# Agent Watch behavioral analytics configuration (v2.7+)
# Provides observability into Claude Code agent sessions via `conductor observe` commands
agent_watch:
  # Enable or disable Agent Watch analytics (default: true)
  enabled: true

  # Base directory for discovering Claude Code session files
  # Default: ~/.claude/projects
  base_dir: "~/.claude/projects"

  # Default number of sessions/entries to display in observe commands (default: 100)
  default_limit: 100

  # Poll interval in seconds for real-time activity streaming (default: 2)
  poll_interval_secs: 2

  # Auto-import new session data into learning database (default: false)
  auto_import: false

  # Maximum number of sessions to cache in memory - LRU cache (default: 50)
  cache_size: 50

  # Cost model pricing per 1M tokens (for cost calculations)
  # Prices as of January 2025
  cost_model:
    sonnet_input: 3.0      # Claude Sonnet input tokens
    sonnet_output: 15.0    # Claude Sonnet output tokens
    haiku_input: 0.80      # Claude Haiku input tokens
    haiku_output: 4.0      # Claude Haiku output tokens
    opus_input: 15.0       # Claude Opus input tokens
    opus_output: 75.0      # Claude Opus output tokens

# Agent Watch Examples

# Example: Disable Agent Watch
# agent_watch:
#   enabled: false

# Example: Custom session directory
# agent_watch:
#   base_dir: "/custom/path/to/sessions"

# Example: Increase cache size for large projects
# agent_watch:
#   cache_size: 200
#   default_limit: 500

# Example: Faster streaming updates
# agent_watch:
#   poll_interval_secs: 1

# Example: Custom cost model (adjust for your pricing)
# agent_watch:
#   cost_model:
#     sonnet_input: 3.0
#     sonnet_output: 15.0
#     haiku_input: 0.25
#     haiku_output: 1.25
#     opus_input: 15.0
#     opus_output: 75.0

# Plan validation configuration
# Controls strictness of plan file validation
validation:
  # How to handle key_point vs success_criteria misalignment
  # Options:
  #   - warn: Log a warning but continue (default)
  #   - strict: Fail validation if key_points exceed success_criteria
  #   - off: Disable the check entirely
  key_point_criteria: warn

  # Enable strict rubric validation when PlannerComplianceSpec is present
  # When true (and plan has PlannerComplianceSpec), validates:
  #   - Terminology alignment between key_points and success_criteria
  #   - Task type constraints (CAPABILITY vs INTEGRATION)
  #   - Documentation targets for doc tasks
  # Default: false (rubric validation only runs if plan's strict_enforcement is true)
  strict_rubric: false

# Task execution configuration (v2.9+)
# Controls behavior during task execution
executor:
  # Run dependency check commands before agent invocation (default: true)
  # When enabled, tasks with runtime_metadata.dependency_checks will have
  # their check commands executed before the agent runs. Task execution
  # is aborted if any check command fails (exits non-zero).
  # Preflight output is streamed to task logs and attached to QC context.
  enforce_dependency_checks: true

  # Run test commands after agent output but before QC review (default: true)
  # When enabled, tasks with test_commands will have their commands executed
  # after the agent completes. With QC enabled: test failures trigger retry with
  # feedback injection (v2.10+). Without QC: hard gate - task fails immediately.
  # Test output is captured and attached to logs.
  enforce_test_commands: true

  # Run optional per-criterion verification commands (default: true)
  # When enabled, structured_criteria with verification blocks are executed
  # after agent output. Unlike test commands, verification failures do NOT
  # block execution - results are injected into QC prompt for final judgment.
  verify_criteria: true

  # Enforce runtime package conflict guard for Go packages (default: true)
  # When enabled, prevents concurrent task execution from modifying the same
  # Go package. Tasks must acquire package locks before execution; conflicts
  # block until released. Package conflicts are also validated at wave
  # calculation time during planning phase.
  enforce_package_guard: true

  # Enforce documentation target verification for documentation tasks (default: true)
  # When enabled, documentation targets are verified before QC to ensure
  # agents edit the exact sections specified in the plan.
  enforce_doc_targets: true

  # Enable error pattern detection on test failures (default: true)
  # When enabled, Conductor will analyze test command failures and categorize them
  # into CODE_LEVEL (agent can fix), PLAN_LEVEL (plan needs update), or ENV_LEVEL
  # (environment issue). Provides actionable suggestions for each category.
  enable_error_pattern_detection: true

  # Enable Claude-based error classification (v2.11+, default: false)
  # When enabled, uses Claude to semantically analyze error messages for more accurate
  # classification. Falls back to regex patterns on timeout/error/low confidence.
  # Confidence threshold: 0.85 minimum (filters low-quality classifications)
  # Cost: ~1-2 cents per error classification (Claude API call)
  enable_claude_classification: false

# Executor Examples

# Example: Disable dependency checks for legacy plans
# executor:
#   enforce_dependency_checks: false

# Example: Skip test command execution (rely only on QC review)
# executor:
#   enforce_test_commands: false

# Example: Disable per-criterion verification (rely on QC judgment)
# executor:
#   verify_criteria: false

# Example: Disable runtime package guard (allow concurrent package modifications)
# executor:
#   enforce_package_guard: false

# Example: Disable documentation target verification
# executor:
#   enforce_doc_targets: false

# Example: Disable error pattern detection on test failures
# executor:
#   enable_error_pattern_detection: false

# Example: Enable Claude-based error classification (v2.11+)
# executor:
#   enable_claude_classification: true

# Budget & Rate Limit Auto-Resume (v2.20+)
# Intelligent rate limit handling with state persistence for long-running plans
budget:
  # Enable or disable budget tracking (default: true)
  enabled: true

  # Enable intelligent wait/exit on rate limit detection (default: true)
  # When rate limit is hit:
  #   - If wait <= max_wait_duration: waits with countdown announcements
  #   - If wait > max_wait_duration: saves state and exits cleanly for later resume
  auto_resume: true

  # Maximum time to wait for rate limit reset (default: 6h)
  # If the detected wait time exceeds this, Conductor saves state and exits
  # Typically session limits are ~5h, so 6h covers most cases
  # Weekly limits (24h+) trigger save-and-exit
  max_wait_duration: 6h

  # How often to announce countdown during wait (default: 15m)
  # Announcements go to console and TTS (if enabled)
  announce_interval: 15m

  # Extra buffer time to wait after reset before resuming (default: 60s)
  # Helps avoid edge cases where the limit hasn't fully reset
  safety_buffer: 60s

# Budget Examples

# Example: Disable intelligent rate limit handling (fail immediately on rate limit)
# budget:
#   enabled: true
#   auto_resume: false

# Example: Shorter max wait (save-and-exit faster for long waits)
# budget:
#   enabled: true
#   auto_resume: true
#   max_wait_duration: 2h

# Example: More frequent countdown announcements
# budget:
#   enabled: true
#   auto_resume: true
#   announce_interval: 5m

# Example: Longer safety buffer for conservative resume
# budget:
#   enabled: true
#   auto_resume: true
#   safety_buffer: 5m

# Resume paused executions with CLI commands:
#   conductor budget list-paused    # Show paused executions
#   conductor budget resume         # Resume all ready executions
#   conductor budget resume <id>    # Resume specific session

# Pattern Intelligence configuration (v2.23+)
# STOP protocol analysis (Search/Think/Outline/Prove) and duplicate detection
# Analyzes tasks for existing solutions, prior art, and potential duplicates
pattern:
  # Enable or disable Pattern Intelligence (default: false)
  enabled: false

  # Operating mode:
  # - block: Hard gate - fail tasks with high similarity to existing work
  # - warn: Soft signal - log warning but allow execution (default)
  # - suggest: Include analysis in agent prompt without any blocking
  mode: warn

  # Similarity threshold to trigger action (0.0-1.0, default: 0.8)
  # Tasks with similarity >= threshold will be flagged based on mode
  similarity_threshold: 0.8

  # Duplicate threshold (0.0-1.0, default: 0.9)
  # Tasks with duplicate score >= threshold may be skipped in block mode
  duplicate_threshold: 0.9

  # Minimum confidence before taking action (0.0-1.0, default: 0.7)
  # Lower confidence predictions are treated as suggestions only
  min_confidence: 0.7

  # Enable STOP protocol analysis (default: true when enabled)
  # STOP = Search / Think / Outline / Prove from CLAWED methodology
  # Searches git history, GitHub issues, docs, and learning database
  enable_stop: true

  # Enable duplicate task detection (default: true when enabled)
  # Uses content hashing and similarity scoring to detect duplicates
  enable_duplicate_detection: true

  # Include pattern analysis in agent prompts (default: true)
  # When enabled, agents receive context about prior art and similar work
  inject_into_prompt: true

  # Maximum patterns to include in prompt injection (default: 5)
  max_patterns_per_task: 5

  # Maximum related files to include in analysis (default: 10)
  max_related_files: 10

  # Cache TTL in seconds for pattern analysis results (default: 3600)
  cache_ttl_seconds: 3600

  # Require implementing agent to justify custom implementations (v2.24+)
  # When STOP protocol finds prior art (existing solutions, similar commits, related issues):
  # - true: QC agents will request justification; weak/missing → YELLOW verdict
  # - false: Prior art is informational only, no justification required
  require_justification: false

  # LLM Enhancement (v2.26+)
  # Uses Claude CLI to refine confidence when in uncertain range
  # Provides TTS + visual countdown during rate limit waits
  llm_enhancement_enabled: false  # Disabled by default
  llm_min_confidence: 0.3         # Enhance when confidence >= this
  llm_max_confidence: 0.7         # Enhance when confidence <= this
  llm_timeout_seconds: 30         # Timeout for Claude CLI response

# Pattern Intelligence Examples

# Example: Enable Pattern Intelligence in warn mode (recommended starting point)
# pattern:
#   enabled: true
#   mode: warn

# Example: Strict blocking mode for high-duplication prevention
# pattern:
#   enabled: true
#   mode: block
#   duplicate_threshold: 0.85

# Example: Enable with justification requirement (v2.24+)
# pattern:
#   enabled: true
#   mode: warn
#   enable_stop: true
#   require_justification: true

# Example: Suggest-only mode (no warnings, just context injection)
# pattern:
#   enabled: true
#   mode: suggest
#   inject_into_prompt: true

# Example: Disable STOP but keep duplicate detection
# pattern:
#   enabled: true
#   enable_stop: false
#   enable_duplicate_detection: true

# Example: Enable LLM enhancement for uncertain confidence (v2.26+)
# pattern:
#   enabled: true
#   llm_enhancement_enabled: true
#   llm_min_confidence: 0.3
#   llm_max_confidence: 0.7

# Validation Examples

# Example: Strict mode - fail validation if key_points exceed success_criteria
# validation:
#   key_point_criteria: strict

# Example: Disable key_point validation entirely
# validation:
#   key_point_criteria: off

# Example: Enable strict rubric validation for all plans with PlannerComplianceSpec
# validation:
#   strict_rubric: true
