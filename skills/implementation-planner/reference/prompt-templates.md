# Prompt Templates for Runtime Enforcement

Reference material for including runtime enforcement metadata in generated implementation plans.

## Overview

Conductor v2.9+ enforces runtime checks during task execution. Plans generated by the implementation-planner skill should include appropriate enforcement metadata to ensure tasks are validated at runtime.

## Runtime Enforcement Modes (RFC 2119 Mapping)

Conductor's enforcement modes map to RFC 2119 requirement levels:

| Mode | Plan Field | Failure Behavior | RFC 2119 Level |
|------|------------|------------------|----------------|
| Dependency Checks | `runtime_metadata.dependency_checks` | **Blocks task** at preflight | **MUST** |
| Test Commands | `test_commands` | **Blocks task** after agent (hard gate) | **MUST** |
| Package Guard | N/A (automatic via `depends_on`) | **Blocks task** if package conflict | **MUST** |
| Success Criteria | `success_criteria` | Passes to QC (soft signal) | **SHOULD** |
| Integration Criteria | `integration_criteria` | Passes to QC (soft signal) | **SHOULD** |
| Criterion Verification | `success_criteria[].verification` | Passes to QC (soft signal) | **SHOULD** |
| Documentation Targets | `runtime_metadata.documentation_targets` | Passes to QC (soft signal) | **MAY** |

**Routing by Requirement Level:**
- **MUST**: Route to `test_commands` or `dependency_checks` (hard gates)
- **SHOULD**: Route to `success_criteria` (QC evaluates, may YELLOW/RED)
- **MAY**: Route to `documentation_targets` (informational, YELLOW max)

## Template: Task with Runtime Enforcement

```yaml
- task_number: N
  name: "Task name"
  type: "component"  # or "integration"
  files:
    - "path/to/file.go"
  depends_on: []
  estimated_time: "30m"
  agent: "golang-pro"

  # PREFLIGHT: Run before agent invocation
  runtime_metadata:
    dependency_checks:
      - command: "go build ./..."
        description: "Verify build succeeds"
      - command: "test -f path/to/dependency.go"
        description: "Verify dependency file exists"

    # POST-AGENT (soft signal): Verify documentation
    documentation_targets:
      - location: "docs/feature.md"
        section: "# Configuration"

    # Prompt enrichment
    prompt_blocks:
      - type: "context"
        content: "Additional context for the agent"
      - type: "constraint"
        content: "Constraints the agent must respect"

  # POST-AGENT (soft signal): Criterion verification
  success_criteria:
    - criterion: "Function X handles edge case Y"
      verification:
        command: "go test -run TestEdgeCaseY"
        expected: "PASS"
    - criterion: "Error messages are user-friendly"
      # No verification = QC subjective review

  # POST-AGENT (hard gate): Test commands
  test_commands:
    - "go test ./path/to/... -v"

  description: |
    Task description here.

  implementation:
    approach: |
      Implementation strategy.
    key_points:
      - point: "Key point"
        details: "Details"
        reference: "file.go"
```

## When to Include Each Mode

### Dependency Checks

Include when task requires:
- Build to succeed before starting
- Specific files to exist
- External tools to be available
- Database/service to be running

```yaml
runtime_metadata:
  dependency_checks:
    - command: "go build ./..."
      description: "Build must succeed"
    - command: "test -f config.yaml"
      description: "Config file must exist"
    - command: "docker ps | grep postgres"
      description: "PostgreSQL must be running"
```

### Documentation Targets

Include when task modifies code that should have documentation:
- API changes → Update API docs
- Config changes → Update config docs
- New features → Update feature docs

```yaml
runtime_metadata:
  documentation_targets:
    - location: "docs/api.md"
      section: "# Authentication"
    - location: "CHANGELOG.md"
      section: "## Unreleased"
```

### Criterion Verification

Include when criteria can be verified programmatically:
- Function exists → grep or go test
- Test coverage → go test -cover
- Performance → benchmark tests
- Security → static analysis

```yaml
success_criteria:
  - criterion: "JWT validation rejects expired tokens"
    verification:
      command: "go test -run TestExpiredToken"
      expected: "PASS"
  - criterion: "Response time under 100ms"
    verification:
      command: "go test -run TestBenchmark -bench=."
      expected: "BenchmarkAPI.*100"
```

### Test Commands

**Always include** for Go projects:

```yaml
test_commands:
  - "go test ./path/to/package/... -v"
```

Test commands are **hard gates** - task is blocked if tests fail.

### Package Guard

Automatic via dependency serialization. When two tasks modify the same Go package, add explicit `depends_on`:

```yaml
# Task 3 and Task 4 both modify internal/executor
# Serialize them to prevent package conflicts

- task_number: 3
  files:
    - "internal/executor/task.go"
  depends_on: [1, 2]

- task_number: 4
  files:
    - "internal/executor/wave.go"
  depends_on: [3]  # Serialize access to internal/executor
```

## Integration Tasks

Integration tasks verify cross-component interactions. Include both `success_criteria` (component-level) and `integration_criteria` (cross-component):

```yaml
- task_number: N
  name: "Wire auth middleware to API"
  type: "integration"
  files:
    - "internal/api/middleware.go"
    - "internal/api/server.go"
  depends_on: [auth_task, api_task]

  success_criteria:
    - criterion: "Middleware function has correct signature"
    - criterion: "Server imports middleware package"

  integration_criteria:
    - "Auth middleware executes before route handlers"
    - "Invalid tokens return 401 status"
    - "Error propagates from auth to API response"

  test_commands:
    - "go test ./internal/api/... -v"
    - "go test ./test/integration/... -run Auth -v"
```

## Auto-Generated Plans

When generating plans, the implementation-planner skill automatically:

1. **Adds dependency checks** for build verification
2. **Adds test commands** for the modified packages
3. **Serializes package access** via `depends_on` when tasks share Go packages
4. **Includes verification blocks** for testable criteria

Plans generated without these fields will still execute but without runtime enforcement guarantees.

## CLI Override Flags

Users can disable enforcement modes at runtime:

```bash
conductor run plan.yaml --no-enforce-dependency-checks
conductor run plan.yaml --no-enforce-test-commands
conductor run plan.yaml --no-enforce-package-guard
conductor run plan.yaml --no-enforce-doc-targets
conductor run plan.yaml --no-verify-criteria
```

Generated plans should assume all enforcement is enabled (the default).
